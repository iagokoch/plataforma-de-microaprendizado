<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aula - MicroLearn</title>
    <link rel="stylesheet" href="/stylesheets/dashboard.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <style>
      /* Basic styles from dashboard.css or similar */
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background-color: #f8f9fa;
      }

      .navbar {
        background: #f3eaff;
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .nav-left,
      .nav-center,
      .nav-right {
        display: flex;
        align-items: center;
      }
      .nav-logo {
        height: 40px;
        margin-right: 1rem;
      }
      .nav-link {
        color: #222;
        text-decoration: none;
        margin: 0 1rem;
        font-weight: 500;
        font-size: 1rem;
      }
      .nav-link:hover {
        color: #7950f2;
      }
      .profile-icon {
        font-size: 2rem;
        color: #7950f2;
        margin-left: 1rem;
      }
      .search-bar {
        display: flex;
        align-items: center;
        background: #fff;
        border-radius: 6px;
        padding: 0.2rem 0.5rem;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
      }
      .search-bar input {
        border: none;
        outline: none;
        padding: 0.4rem;
        font-size: 1rem;
        background: transparent;
      }
      .search-button {
        background: none;
        border: none;
        color: #7950f2;
        font-size: 1.2rem;
        cursor: pointer;
      }

      .page-title {
        background: #f3eaff;
        padding: 1.5rem 0 1rem 0;
        text-align: center;
        font-size: 1.2rem;
        color: #222;
        margin-bottom: 1rem;
      }

      .subjects-menu {
        display: flex;
        justify-content: center;
        background: #f3eaff;
        padding: 0.8rem 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
      }

      .subject-link {
        text-decoration: none;
        color: #222;
        margin: 0 1rem;
        font-weight: 500;
        transition: color 0.3s;
      }

      .subject-link:hover {
        color: #7950f2;
        border-bottom: 2px solid #7950f2; /* Highlight effect */
        padding-bottom: 4px; /* Space for the underline */
      }

      .aula-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 0 1rem;
      }

      .video-section {
        margin-bottom: 2rem;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .video-placeholder-aula {
        width: 100%;
        height: 450px; /* Adjust height as needed */
        background-color: #ddd; /* Placeholder color */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #666;
      }

      .question-section {
        background: #fff;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .question-section h3 {
        color: #7950f2;
        margin-bottom: 1.5rem;
        text-align: center;
        font-size: 1.4rem;
      }

      .options-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
      }

      .option-item {
        display: flex;
        align-items: center;
        background: #f3eaff;
        padding: 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .option-item:hover {
        background-color: #e9d8ff;
      }

      .option-item input[type="radio"] {
        margin-right: 0.8rem;
        accent-color: #7950f2; /* Style the radio button color */
      }

      .option-item label {
        flex-grow: 1; /* Ensure label takes available space */
        cursor: pointer; /* Keep cursor as pointer for label */
      }
    </style>
  </head>
  <body class="<%= user && user.theme === 'dark' ? 'dark-mode' : '' %>">
    <% if (!user) { %>
    <div
      id="login-popup"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      "
    >
      <div
        style="
          background: #fff;
          padding: 2rem 2.5rem;
          border-radius: 10px;
          box-shadow: 0 2px 16px rgba(0, 0, 0, 0.2);
          text-align: center;
          max-width: 90vw;
        "
      >
        <h2 style="color: #7950f2; margin-bottom: 1rem">
          Faça login para acessar a aula
        </h2>
        <p style="margin-bottom: 1.5rem">
          Você precisa estar logado para ver o conteúdo da aula.
        </p>
        <a href="/login"
          ><button
            style="
              background: #7950f2;
              color: #fff;
              border: none;
              border-radius: 6px;
              padding: 0.7rem 2rem;
              font-size: 1.1rem;
              cursor: pointer;
            "
          >
            Ir para Login
          </button></a
        >
      </div>
    </div>
    <script>
      document.body.style.overflow = "hidden";
    </script>
    <% } %>
    <%- include('partials/navbar', { user: user }) %>

    <!-- Título da página (pode ser o título da aula) -->
    <div class="page-title">Título da Aula</div>

    <!-- Menu de matérias -->
    <div class="subjects-menu">
      <a href="/matematica" class="subject-link">Matemática</a>
      <a href="/ciencias" class="subject-link">Ciências</a>
      <a href="/lingua-portuguesa" class="subject-link">Língua Portuguesa</a>
      <a href="/geografia" class="subject-link">Geografia</a>
      <a href="/filosofia" class="subject-link">Filosofia</a>
      <a href="/mais" class="subject-link">Mais</a>
    </div>

    <div class="aula-container">
      <% var aula = typeof aula !== 'undefined' ? aula : null; %>
      <% if (!aula) { %>
        <div class="video-section">
          <div class="video-placeholder-aula">Erro ao carregar vídeo.</div>
        </div>
      <% } else { %>
        <div class="video-section" style="text-align:center;">
          <h2 style="color:#7950f2;margin-bottom:0.5rem;"><%= aula.titulo %></h2>
          <div style="color:#888;margin-bottom:1.2rem;">Matéria: <%= aula.materia %></div>
          <iframe width="80%" height="420" src="<%= aula.video_url %>" frameborder="0" allowfullscreen style="border-radius:12px;"></iframe>
        </div>
        <div class="perguntas-section" style="background:#fff;padding:2rem 1rem 1.5rem 1rem;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05);margin-top:2rem;">
          <h3 style="color:#7950f2;text-align:center;margin-bottom:1.2rem;">Perguntas sobre o vídeo</h3>
          <% if (perguntas && perguntas.length > 0) { %>
            <form id="quiz-form">
              <ul style="max-width:600px;margin:0 auto;list-style:decimal inside;">
                <% perguntas.forEach(function(p, idx) { %>
                  <li style="margin-bottom:1.5rem;font-size:1.1rem;color:#444;">
                    <div><%= p.texto %></div>
                    <% if (alternativas && alternativas[p.id] && alternativas[p.id].length > 0) { %>
                      <div style="margin-top:0.7rem;">
                        <% alternativas[p.id].forEach(function(alt) { %>
                          <label style="display:block;margin-bottom:0.4rem;">
                            <input type="radio" name="pergunta_<%= p.id %>" value="<%= alt.id %>"> <%= alt.texto %>
                          </label>
                        <% }) %>
                      </div>
                    <% } %>
                  </li>
                <% }) %>
              </ul>
              <div style="text-align:center;margin-top:2rem;">
                <button type="button" id="btn-concluir" style="background:#51cf66;color:#fff;padding:0.7rem 2rem;border-radius:6px;font-weight:bold;border:none;cursor:pointer;">Concluído</button>
              </div>
            </form>
            <script>
            document.addEventListener('DOMContentLoaded', function() {
              const form = document.getElementById('quiz-form');
              if (form) {
                const perguntas = <%- JSON.stringify(perguntas) %>;
                const alternativas = <%- JSON.stringify(alternativas) %>;
                form.addEventListener('submit', function(e) { e.preventDefault(); });
                document.getElementById('btn-concluir').onclick = function() {
                  let allCorrect = true;
                  for (let i = 0; i < perguntas.length; i++) {
                    const p = perguntas[i];
                    const checked = form.querySelector('input[name="pergunta_' + p.id + '"]:checked');
                    if (!checked) { allCorrect = false; break; }
                    const altId = parseInt(checked.value);
                    const correta = (alternativas[p.id] || []).find(function(a) { return a.correta; });
                    if (!correta || correta.id != altId) { allCorrect = false; break; }
                  }
                  if (!allCorrect) {
                    alert('Resposta incorreta! Tente novamente.');
                  } else {
                    // AJAX para marcar como concluída
                    fetch(`/aula/<%= aula.id %>/concluir`, { method: 'POST' })
                      .then(res => res.json())
                      .then(data => {
                        if (data.success) {
                          alert('Parabéns! Você concluiu a aula.');
                          window.location.href = '/minhas-tarefas';
                        } else {
                          alert('Erro ao marcar como concluída.');
                        }
                      })
                      .catch(() => alert('Erro ao marcar como concluída.'));
                  }
                }
              }
            });
            </script>
          <% } else { %>
            <div style="color:#888;text-align:center;">Nenhuma pergunta cadastrada para esta matéria.</div>
          <% } %>
        </div>
      <% } %>
      <div style="text-align:center;margin-top:2rem;">
        <a href="/" style="background:#7950f2;color:#fff;padding:0.7rem 2rem;border-radius:6px;text-decoration:none;font-weight:bold;">Voltar</a>
      </div>
    </div>

    <!-- Optional: Add a footer if needed -->
    <!-- Include your footer EJS partial here if you have one -->
  </body>
</html>
